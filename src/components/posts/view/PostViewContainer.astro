---
import type { Post } from '@api/ghost/types';
import { PostType } from '@api/ghost/types';
import DefaultCard from './cards/DefaultCard.astro';
import ArticleCard from './cards/ArticleCard.astro';
import MusicCard from './cards/MusicCard.astro';
import VideoCard from './cards/VideoCard.astro';
import GalleryCard from './cards/GalleryCard.astro';
import PostViewScrollContainer from './PostViewScrollContainer';

interface Props {
    posts: Post[];
}

const { posts } = Astro.props;

// 提取所有文章的发布日期
const postDates = posts.map((post) => post.published_at);
---

<PostViewScrollContainer client:idle postDates={postDates}>
    {
        posts.map((post) => {
            const PostCardComponent = (() => {
                switch (post.post_type) {
                    case PostType.DEFAULT:
                        return DefaultCard;
                    case PostType.ARTICLE:
                        return ArticleCard;
                    case PostType.MUSIC:
                        return MusicCard;
                    case PostType.VIDEO:
                        return VideoCard;
                    case PostType.GALLERY:
                        return GalleryCard;
                    default:
                        return DefaultCard;
                }
            })();

            return (
                <a
                    href={`/posts/${post.id}`}
                    class="post-card-wrapper flex shrink-0 items-center justify-center transition-all duration-300 ease-out hover:z-10 hover:scale-[1.02]"
                >
                    <PostCardComponent post={post} />
                </a>
            );
        })
    }
</PostViewScrollContainer>

<style>
    .post-card-wrapper {
        width: 298px; /* 302 - 4 */
        height: 594px;
    }

    /* 触摸设备基础优化 (手机、平板) */
    @media (pointer: coarse) {
        .post-card-wrapper {
            width: 260px;
            height: 520px;
        }
    }

    /* 大屏触摸设备 (iPad 横屏、iPad Pro 等) */
    @media (pointer: coarse) and (min-width: 1024px) {
        .post-card-wrapper {
            width: 300px;
            height: 590px;
        }
    }

    /* 桌面端大屏 (非触摸设备) */
    @media (pointer: fine) and (min-width: 1440px) {
        .post-card-wrapper {
            width: 342px; /* 346 - 4 */
            height: 673px;
        }
    }

    @media (pointer: fine) and (min-width: 1920px) {
        .post-card-wrapper {
            width: 385px; /* 389 - 4 */
            height: 766px;
        }
    }

    @media (pointer: fine) and (min-width: 2560px) {
        .post-card-wrapper {
            width: 428px; /* 432 - 4 */
            height: 880px;
        }
    }

    /* 兼容性回退：保留原有大屏断点（针对不支持 pointer 查询的浏览器） */
    @supports not (selector(:has(*))) {
        @media (min-width: 1440px) {
            .post-card-wrapper {
                width: 342px;
                height: 673px;
            }
        }

        @media (min-width: 1920px) {
            .post-card-wrapper {
                width: 385px;
                height: 766px;
            }
        }

        @media (min-width: 2560px) {
            .post-card-wrapper {
                width: 428px;
                height: 880px;
            }
        }
    }
</style>
