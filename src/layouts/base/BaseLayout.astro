---
import '@styles/index.css';
import GoogleAnalytics from '@components/utils/GoogleAnalytics.astro';
import type { AlternateLink } from '@lib/i18n';

interface Props {
    siteTitle: string;
    coverImageUrl: URL | string | null;
    lang?: string;
    canonicalUrl?: string;
    alternateLinks?: AlternateLink[];
}

const {
    siteTitle,
    coverImageUrl,
    lang = 'zh-CN',
    canonicalUrl,
    alternateLinks = [],
} = Astro.props;

const coverImageUrlStr = coverImageUrl
    ? `url(${coverImageUrl.toString()})`
    : 'none';
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />

        <!-- Security Headers -->
        <meta http-equiv="X-Content-Type-Options" content="nosniff" />
        <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
        <meta name="referrer" content="strict-origin-when-cross-origin" />
        <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; font-src 'self' data:; connect-src 'self' https://www.google-analytics.com; frame-ancestors 'self';"
        />

        {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
        {
            alternateLinks.map((link) => (
                <link
                    rel="alternate"
                    hreflang={link.hreflang}
                    href={link.href}
                />
            ))
        }
        <GoogleAnalytics />
        <style data-emotion-insertion-point="emotion"></style>
        <title>{siteTitle}</title>
    </head>
    <body>
        <div class="solitude-body"></div>
        <slot />
    </body>
</html>

<style define:vars={{ coverImageUrlStr }}>
    .solitude-body {
        top: 0;
        left: 0;
        position: fixed;
        z-index: -10;
        height: 100vh;
        width: 100vw;
        background-size: cover;
        background-image: var(--coverImageUrlStr);
    }

    /* 遮罩层使用伪元素，颜色从 theme.css 动态加载 */
    .solitude-body::before {
        content: '';
        position: absolute;
        inset: 0;
        background-color: var(--site-bg-overlay);
        pointer-events: none;
    }
</style>

<script is:inline>
    // 安全地解析主题设置，验证值的有效性
    function getValidTheme(stored) {
        if (!stored) return 'dark';
        try {
            const parsed = JSON.parse(stored);
            // 只接受有效的主题值
            return parsed === 'dark' || parsed === 'light' ? parsed : 'dark';
        } catch {
            return 'dark';
        }
    }

    const storedTheme = localStorage.getItem('theme');
    const themeMode = getValidTheme(storedTheme);
    document.documentElement.classList.add(themeMode);

    // 监听主题切换事件
    window.addEventListener('themeChanged', function (e) {
        const newTheme = e.detail.theme;
        // 验证新主题值
        if (newTheme !== 'dark' && newTheme !== 'light') return;
        document.documentElement.classList.toggle('dark', newTheme === 'dark');
        document.documentElement.classList.toggle(
            'light',
            newTheme === 'light',
        );
    });
</script>
