---
import DockNav from '@components/layout/dock/DockNav.astro';
import DockSocial from '@components/layout/dock/DockSocial.astro';
import DockTimeline from '@components/layout/dock/timeline/DockTimeline.astro';
import Dock from '@components/layout/dock/Dock.astro';
import PostViewContainer from '@components/posts/view/PostViewContainer.astro';
import { listAllPosts } from '@api/ghost/posts';
import { initializeSiteData } from '@api/ghost/settings';
import BaseLayout from '@layouts/base/BaseLayout.astro';
import SiteNavbar from '@components/layout/navbar/SiteNavbar.astro';
import {
    LOCALES,
    type Locale,
    isLocale,
    LOCALE_HTML_LANG,
    generateAlternateLinks,
    filterPostsByLocale,
} from '@lib/i18n';
import { env } from '@api/config/env';

export async function getStaticPaths() {
    return LOCALES.map((lang) => ({
        params: { lang },
    }));
}

const { lang } = Astro.params;

if (!isLocale(lang)) {
    return Astro.redirect('/zh/post-view');
}

const locale = lang as Locale;
const htmlLang = LOCALE_HTML_LANG[locale];

const { siteTitle, siteDescription, logoUrl, coverImageUrl } =
    await initializeSiteData();

// 获取所有文章
const allPosts = await listAllPosts({ limit: 100 });
// 按语言过滤：优先显示当前语言，如果没有则显示其他语言版本
const localizedPosts = filterPostsByLocale(allPosts, locale);
// 提取文章对象（已按发布日期排序）
const posts = localizedPosts.map(item => item.post);

// 生成 hreflang 链接
const alternateLinks = generateAlternateLinks(env.site.url, '/post-view', LOCALES);
const canonicalUrl = `${env.site.url}/${locale}/post-view`;
---

<BaseLayout 
    siteTitle={siteTitle} 
    coverImageUrl={coverImageUrl}
    lang={htmlLang}
    canonicalUrl={canonicalUrl}
    alternateLinks={alternateLinks}
>
    <SiteNavbar
        logoUrl={logoUrl}
        siteTitle={siteTitle}
        siteSubTitle={siteDescription}
    />
    <PostViewContainer posts={posts} />
    <Dock isFixed={true}>
        <!-- Timeline 在移动端隐藏 -->
        <div class="hidden lg:block">
            <DockTimeline posts={posts} />
        </div>
        <DockNav lang={locale} />
        <DockSocial lang={locale} />
    </Dock>
</BaseLayout>

<style>
    /* 禁止页面垂直滚动，让滚轮事件只作用于横向滚动容器 */
    :global(html),
    :global(body) {
        overflow: hidden;
        height: 100vh;
    }
</style>

<script>
    // 页面加载后立即开始监听滚轮事件
    // 这样即使 React 还没水合完成，也能拦截垂直滚动
    document.addEventListener('DOMContentLoaded', () => {
        const scrollContainer = document.querySelector('.post-view-scroll-container');
        
        if (scrollContainer) {
            // 计算滚动距离
            const getScrollDistance = () => {
                const card = scrollContainer.querySelector('.post-card-wrapper');
                const cardWidth = card?.getBoundingClientRect().width || 300;
                const gap = 60;
                return cardWidth + gap;
            };

            // 处理滚轮事件
            const handleWheel = (e: WheelEvent) => {
                const container = scrollContainer as HTMLElement;
                const { scrollWidth, clientWidth, scrollLeft } = container;
                const canScroll = scrollWidth > clientWidth;

                // 判断是否在边界
                const atStart = scrollLeft <= 0 && e.deltaY < 0;
                const atEnd = scrollLeft >= scrollWidth - clientWidth && e.deltaY > 0;

                // 拦截滚动事件
                if (canScroll && !atStart && !atEnd) {
                    e.preventDefault();
                    e.stopPropagation();

                    const scrollDistance = getScrollDistance();
                    const direction = e.deltaY > 0 ? 1 : -1;
                    
                    container.scrollBy({
                        left: direction * scrollDistance,
                        behavior: 'smooth',
                    });
                }
            };

            // 使用 passive: false 以便能够 preventDefault
            document.addEventListener('wheel', handleWheel, { passive: false });
        }
    });
</script>
