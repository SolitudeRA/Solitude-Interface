---
import { listPostsByLocale } from '@api/ghost/posts';
import { initializeSiteData } from '@api/ghost/settings';
import BaseLayout from '@layouts/base/BaseLayout.astro';
import IndexLayout from '@layouts/IndexLayout.astro';
import Navbar from '@layouts/base/Navbar.astro';
import Dock from '@layouts/base/Dock.astro';
import NavbarBrand from '@components/layout/navbar/NavbarBrand.astro';
import NavbarUtility from '@components/layout/navbar/NavbarUtility.astro';
import DockNav from '@components/layout/dock/nav/DockNav.astro';
import DockSocial from '@components/layout/dock/social/DockSocial.astro';
import {
    LOCALES,
    type Locale,
    isLocale,
    LOCALE_HTML_LANG,
    generateAlternateLinks,
} from '@lib/i18n';
import { env } from '@api/config/env';

export async function getStaticPaths() {
    return LOCALES.map((lang) => ({
        params: { lang },
    }));
}

const { lang } = Astro.params;

if (!isLocale(lang)) {
    return Astro.redirect('/zh/');
}

const locale = lang as Locale;
const htmlLang = LOCALE_HTML_LANG[locale];

const { siteTitle, siteDescription, logoUrl, coverImageUrl } =
    await initializeSiteData();
const posts = await listPostsByLocale(locale);

// 生成 hreflang 链接
const alternateLinks = generateAlternateLinks(env.site.url, '', LOCALES);
const canonicalUrl = `${env.site.url}/${locale}`;
---

<BaseLayout
    siteTitle={siteTitle}
    coverImageUrl={coverImageUrl}
    lang={htmlLang}
    canonicalUrl={canonicalUrl}
    alternateLinks={alternateLinks}
>
    <Navbar>
        <NavbarBrand
            logoImageUrl={logoUrl}
            siteTitle={siteTitle}
            siteSubTitle={siteDescription}
        />
        <NavbarUtility />
    </Navbar>

    <main class="mx-auto">
        <IndexLayout posts={posts} />
    </main>

    <Dock isFixed={true}>
        <div></div>
        <DockNav />
        <DockSocial />
    </Dock>
</BaseLayout>
