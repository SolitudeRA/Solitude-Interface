# é¡¹ç›®æ¶æ„è®¾è®¡

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Solitude Interface çš„æ¶æ„è®¾è®¡ã€æ•°æ®æµå‘å’Œæ ¸å¿ƒæ¨¡å—å®ç°ã€‚

## ğŸ“ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Astro SSG æ„å»ºå±‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  pages/     â”‚  â”‚  layouts/   â”‚  â”‚ components/ â”‚              â”‚
â”‚  â”‚  (è·¯ç”±)     â”‚  â”‚  (å¸ƒå±€)     â”‚  â”‚  (UIç»„ä»¶)   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                â”‚                â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                          â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    API å±‚ (src/api/)                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ ghost/  â”‚  â”‚ adapters â”‚  â”‚ clients â”‚  â”‚   utils/    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ posts   â”‚â”€â”€â”‚  ghost   â”‚â”€â”€â”‚  ghost  â”‚â”€â”€â”‚ cache/error â”‚  â”‚  â”‚
â”‚  â”‚  â”‚settings â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     Ghost CMS API       â”‚
              â”‚   (Content API v5.0)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµå‘

### æ„å»ºæ—¶æ•°æ®è·å–æµç¨‹

```
1. Astro é¡µé¢è¯·æ±‚æ•°æ®
   â””â”€> src/pages/[lang]/index.astro
       â””â”€> getStaticPaths()

2. è°ƒç”¨ Ghost API æ¨¡å—
   â””â”€> src/api/ghost/posts.ts
       â””â”€> getPosts({ filter: 'tag:hash-lang-zh' })

3. Ghost å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
   â””â”€> src/api/clients/ghost.ts
       â””â”€> axios.get('/posts', { params })

4. ç¼“å­˜æ£€æŸ¥ (å‘½ä¸­åˆ™è¿”å›ç¼“å­˜)
   â””â”€> src/api/utils/cache.ts
       â””â”€> getFromCache(key) || fetchAndCache()

5. æ•°æ®é€‚é…è½¬æ¢
   â””â”€> src/api/adapters/ghost.ts
       â””â”€> adaptGhostPost(rawPost)
           â”œâ”€> æå–æ ‡ç­¾ä¿¡æ¯ (type, category, series)
           â””â”€> è½¬æ¢ URL æ ¼å¼

6. è¿”å›å¤„ç†åçš„æ•°æ®ç»™é¡µé¢
```

### å®¢æˆ·ç«¯äº¤äº’æµç¨‹

```
ç”¨æˆ·äº¤äº’ â†’ React ç»„ä»¶ â†’ Jotai Store â†’ UI æ›´æ–°
                â†“
        src/stores/postViewAtom.ts
        src/stores/themeAtom.ts
```

---

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. API å±‚ (`src/api/`)

#### æ¨¡å—ç»“æ„

```
api/
â”œâ”€â”€ config/env.ts       # ç¯å¢ƒå˜é‡é…ç½® (Ghost URL, API Key ç­‰)
â”œâ”€â”€ clients/ghost.ts    # Axios å®¢æˆ·ç«¯å®ä¾‹
â”œâ”€â”€ ghost/
â”‚   â”œâ”€â”€ posts.ts        # æ–‡ç« ç›¸å…³ API
â”‚   â”œâ”€â”€ settings.ts     # ç«™ç‚¹è®¾ç½® API
â”‚   â””â”€â”€ types.ts        # Ghost æ•°æ®ç±»å‹å®šä¹‰
â”œâ”€â”€ adapters/ghost.ts   # æ•°æ®è½¬æ¢å™¨
â””â”€â”€ utils/
    â”œâ”€â”€ cache.ts        # è¯·æ±‚ç¼“å­˜
    â””â”€â”€ errorHandlers.ts # é”™è¯¯å¤„ç†
```

#### å…³é”®å‡½æ•°

```typescript
// src/api/ghost/posts.ts
export async function getPosts(options?: GetPostsOptions): Promise<Post[]>;
export async function getPostBySlug(slug: string): Promise<Post | null>;
export async function getFeaturedPosts(): Promise<FeaturedPost[]>;

// src/api/ghost/settings.ts
export async function getSiteSettings(): Promise<SiteSettings>;
```

#### é€‚é…å™¨é€»è¾‘

```typescript
// src/api/adapters/ghost.ts
// æ ‡ç­¾å‰ç¼€å®šä¹‰
const TAG_PREFIXES = {
    TYPE: 'type-', // æ–‡ç« ç±»å‹: type-article, type-gallery
    CATEGORY: 'category-', // åˆ†ç±»: category-tech
    SERIES: 'series-', // ç³»åˆ—: series-astro-tutorial
};

// ä» Ghost åŸå§‹æ•°æ®è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼
export function adaptGhostPost(post: GhostPost): Post {
    return {
        ...post,
        url: convertToFrontendUrl(post.id),
        post_type: extractTagValue(post.tags, 'TYPE'),
        post_category: extractTagValue(post.tags, 'CATEGORY'),
        post_series: extractTagValue(post.tags, 'SERIES'),
        post_general_tags: extractGeneralTags(post.tags),
    };
}
```

---

### 2. å¤šè¯­è¨€ç³»ç»Ÿ (`src/lib/i18n.ts`)

#### æ ¸å¿ƒæ¦‚å¿µ

```
Ghost å†…éƒ¨æ ‡ç­¾ (Internal Tags)
    #lang-zh  â†’  API slug: hash-lang-zh
    #i18n-key â†’  API slug: hash-i18n-key

URL è·¯ç”±ç»“æ„
    /{locale}/           â†’ æ–‡ç« åˆ—è¡¨é¡µ
    /{locale}/p/{key}    â†’ æ–‡ç« è¯¦æƒ…é¡µ
```

#### å…³é”®å‡½æ•°

```typescript
// è¯­è¨€é…ç½®
export const LOCALES = ['zh', 'ja', 'en'] as const;
export const DEFAULT_LOCALE: Locale = 'zh';

// è¯­è¨€æå–
export function extractLocaleFromTags(tags: PostTag[]): Locale | null;
export function extractI18nKey(tags: PostTag[]): string | null;

// å¤šè¯­è¨€æ–‡ç« è¿‡æ»¤
export function filterPostsByLocale<T>(
    posts: T[],
    currentLocale: Locale,
): LocalizedPost<T>[];
```

#### å¤šè¯­è¨€æ–‡ç« è¿‡æ»¤é€»è¾‘

```
è¾“å…¥: æ‰€æœ‰æ–‡ç«  + å½“å‰è¯­è¨€
å¤„ç†:
  1. æŒ‰ i18n key åˆ†ç»„æ–‡ç« 
  2. æ¯ç»„ä¼˜å…ˆé€‰æ‹©å½“å‰è¯­è¨€ç‰ˆæœ¬
  3. æ— å½“å‰è¯­è¨€ç‰ˆæœ¬æ—¶ï¼Œé€‰æ‹© fallback ç‰ˆæœ¬
  4. æŒ‰å‘å¸ƒæ—¥æœŸæ’åº
è¾“å‡º: å»é‡åçš„æ–‡ç« åˆ—è¡¨ + fallback æ ‡è®°
```

---

### 3. ç»„ä»¶æ¶æ„ (`src/components/`)

#### ç»„ä»¶åˆ†å±‚

```
components/
â”œâ”€â”€ common/          # åŸºç¡€ UI ç»„ä»¶ (æ— ä¸šåŠ¡é€»è¾‘)
â”‚   â”œâ”€â”€ button.tsx
â”‚   â”œâ”€â”€ card.tsx
â”‚   â””â”€â”€ ...
â”œâ”€â”€ layout/          # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ navbar/      # å¯¼èˆªæ 
â”‚   â””â”€â”€ dock/        # åº•éƒ¨å·¥å…·æ 
â”œâ”€â”€ posts/           # æ–‡ç« ç›¸å…³ç»„ä»¶
â”‚   â”œâ”€â”€ view/        # æ–‡ç« åˆ—è¡¨è§†å›¾
â”‚   â””â”€â”€ detail/      # æ–‡ç« è¯¦æƒ…è§†å›¾
â””â”€â”€ pages/           # é¡µé¢ä¸“ç”¨ç»„ä»¶
    â”œâ”€â”€ about/
    â””â”€â”€ contact/
```

#### Astro vs React ç»„ä»¶é€‰æ‹©

| ç»„ä»¶ç±»å‹ | æ–‡ä»¶æ ¼å¼        | ä½¿ç”¨åœºæ™¯                               |
| -------- | --------------- | -------------------------------------- |
| é™æ€å¸ƒå±€ | `.astro`        | Navbar, Footer, PageHero               |
| äº¤äº’ç»„ä»¶ | `.tsx`          | ThemeSwitch, Carousel, ScrollContainer |
| æ··åˆç»„ä»¶ | `.astro` + slot | å¸ƒå±€åŒ…è£¹äº¤äº’å†…å®¹                       |

---

### 4. çŠ¶æ€ç®¡ç† (`src/stores/`)

#### Jotai Atoms

```typescript
// src/stores/themeAtom.ts
// ä¸»é¢˜çŠ¶æ€ (æŒä¹…åŒ–åˆ° localStorage)
export const themeAtom = atomWithLocalStorage<Theme>('theme', 'system');

// src/stores/postViewAtom.ts
// æ–‡ç« è§†å›¾çŠ¶æ€
export const postViewAtom = atom<PostViewState>({
    totalPosts: 0,
    visibleIndices: [],
    activeIndex: 0,
    postDates: [],
});

// è·¨ç»„ä»¶é€šä¿¡: æ—¶é—´çº¿ â†’ æ»šåŠ¨å®¹å™¨
export const scrollToPostAtom = atom<number | null>(null);
```

#### çŠ¶æ€æµå‘

```
ç”¨æˆ·ç‚¹å‡»æ—¶é—´çº¿èŠ‚ç‚¹
    â†“
DockTimelineMain.tsx
    â†“ setScrollToPostRequest(index)
scrollToPostAtom æ›´æ–°
    â†“
PostViewScrollContainer.tsx (ç›‘å¬)
    â†“ scrollToPost(index)
æ»šåŠ¨åˆ°å¯¹åº”æ–‡ç« 
```

---

### 5. æ ·å¼ç³»ç»Ÿ (`src/styles/`)

#### æ ·å¼å±‚çº§

```
styles/
â”œâ”€â”€ index.css              # å…¥å£ (å¯¼å…¥æ‰€æœ‰æ ·å¼)
â”œâ”€â”€ tailwind-settings.css  # Tailwind é…ç½®
â”œâ”€â”€ theme.css              # ä¸»é¢˜å˜é‡ (CSS è‡ªå®šä¹‰å±æ€§)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ navbar.css
â”‚   â””â”€â”€ article/           # æ–‡ç« æ ·å¼
â”‚       â”œâ”€â”€ article-content.css
â”‚       â”œâ”€â”€ article-layout.css
â”‚       â””â”€â”€ article-toc.css
â””â”€â”€ utilities/
    â””â”€â”€ text-utilities.css
```

#### ä¸»é¢˜ç³»ç»Ÿ

```css
/* src/styles/theme.css */
:root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    /* ... */
}

.dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    /* ... */
}
```

---

## ğŸ”§ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„æ–‡ç« ç±»å‹

1. åœ¨ Ghost ä¸­åˆ›å»ºæ–°æ ‡ç­¾: `type-newtype`
2. åœ¨ `src/components/posts/view/cards/` æ·»åŠ æ–°å¡ç‰‡ç»„ä»¶
3. åœ¨ `PostViewContainer.astro` ä¸­æ·»åŠ ç±»å‹åˆ¤æ–­

### æ·»åŠ æ–°è¯­è¨€

1. åœ¨ `src/lib/i18n.ts` çš„ `LOCALES` æ•°ç»„æ·»åŠ è¯­è¨€ä»£ç 
2. åœ¨ `LOCALE_NAMES` å’Œ `LOCALE_HTML_LANG` æ·»åŠ æ˜ å°„
3. åœ¨ `astro.config.mjs` çš„ `i18n.locales` æ·»åŠ è¯­è¨€
4. åœ¨ Ghost ä¸­ä½¿ç”¨ `#lang-{newlocale}` æ ‡ç­¾

### æ·»åŠ æ–° API ç«¯ç‚¹

1. åœ¨ `src/api/ghost/` åˆ›å»ºæ–°æ¨¡å—
2. å®šä¹‰ç±»å‹åˆ° `types.ts`
3. å®ç°æ•°æ®è·å–å‡½æ•°
4. åœ¨éœ€è¦æ—¶æ·»åŠ é€‚é…å™¨è½¬æ¢

---

## ğŸ“Š æ€§èƒ½è€ƒé‡

### ç¼“å­˜ç­–ç•¥

- æ„å»ºæ—¶: Ghost API å“åº”ç¼“å­˜ (å†…å­˜ç¼“å­˜)
- è¿è¡Œæ—¶: é™æ€ç”Ÿæˆçš„ HTMLï¼Œæ— æœåŠ¡ç«¯è¯·æ±‚

### ä»£ç åˆ†å‰²

- Astro è‡ªåŠ¨åˆ†å‰²æ¯ä¸ªé¡µé¢
- React ç»„ä»¶æŒ‰éœ€ hydration (`client:load`, `client:visible`)

### å›¾ç‰‡ä¼˜åŒ–

- ä½¿ç”¨ Astro Image ç»„ä»¶
- è¿œç¨‹å›¾ç‰‡åŸŸåç™½åå•é…ç½®

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

| æµ‹è¯•ç±»å‹ | è¦†ç›–èŒƒå›´               | å‘½ä»¤                    |
| -------- | ---------------------- | ----------------------- |
| å•å…ƒæµ‹è¯• | é€‚é…å™¨ã€å·¥å…·å‡½æ•°ã€i18n | `pnpm test:unit`        |
| é›†æˆæµ‹è¯• | Ghost API è°ƒç”¨ã€æ•°æ®æµ | `pnpm test:integration` |

### æµ‹è¯•æ–‡ä»¶å‘½å

- å•å…ƒæµ‹è¯•: `*.test.ts`
- é›†æˆæµ‹è¯•: `*.integration.test.ts`
