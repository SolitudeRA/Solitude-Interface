name: CI

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop, master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

# ==============================================
# CI Environment Variables
# Uses Ghost Demo API for build validation only
# ==============================================
env:
  GHOST_URL: https://demo.ghost.io
  GHOST_CONTENT_KEY: '22444f78447824223cefc48062'
  GHOST_VERSION: v5.0
  GHOST_TIMEOUT: '5000'
  SITE_URL: https://example.com
  IMAGE_HOST_URL: ''
  GOOGLE_ANALYTICS_TAG_ID: ''

jobs:
  # ============================================
  # Setup job: Install dependencies and cache
  # ============================================
  setup:
    name: ðŸ“¦ Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Astro sync (generate types)
        run: pnpm astro sync

      - name: Cache dependencies
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            .astro
          key: deps-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}

  # ============================================
  # Lint job: Format checking with Prettier
  # ============================================
  lint:
    name: ðŸŽ¨ Lint
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Restore dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .astro
          key: deps-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Format check (prettier)
        run: pnpm format:check

  # ============================================
  # Typecheck job: TypeScript type checking
  # ============================================
  typecheck:
    name: ðŸ” Typecheck
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Restore dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .astro
          key: deps-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Typecheck (astro check)
        run: pnpm astro check

  # ============================================
  # Test job: Run unit tests with Vitest
  # ============================================
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Restore dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .astro
          key: deps-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Test (vitest run)
        run: pnpm test:run

  # ============================================
  # Build job: Build the project
  # ============================================
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Restore dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            .astro
          key: deps-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ github.sha }}
          fail-on-cache-miss: true

      - name: Build
        run: pnpm build

      - name: Summary
        run: |
          echo "## âœ… CI Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Typecheck | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | âœ… |" >> $GITHUB_STEP_SUMMARY
